<!DOCTYPE html>
<html>
<head>
 	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <title>百度地图离线API V2.1  www.xiaoguo123.com</title>
	<style type="text/css">
  body, html,#map_demo,#menuLayer, #tab, #mapfrm {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
  #menu{height:100%;overflow-y:auto}
  td{font-size:14px}
  h4{margin:0;}
  </style>
  <script type="text/javascript" src="../../offlinemap/map_load.js"></script>
  <link rel="stylesheet" type="text/css" href="../../offlinemap/css/map.css"/>
  <script type="text/javascript" src="../jquery.js"></script>
  <script type="text/javascript" src="../layer/layer.js"></script>

</head>
<body>

<div id="map_demo"></div>
<div id="menuLayer">
    
    <input id="待发送消息" type="text" name="msgText" />
    <input type="button" onclick="onBtnSendMsg();" value="发送消息到浏览器" />
    
</div>
</body>
<script type="text/javascript" src="../qwebchannel.js"></script>
<script type="text/javascript">  
	// 百度地图API功能
	var map = new BMap.Map("map_demo");    // 创建Map实例
	map.centerAndZoom(new BMap.Point(122.089079,37.532558), 18);  // 初始化地图,设置中心点坐标和地图级别
	map.setCurrentCity("哈尔滨工业大学威海校区");          // 设置地图中心显示的城市 new！
	map.setMapType(BMAP_HYBRID_MAP); //模式显示卫星地图，卫星地图在tiles_hybird目录下
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
	map.addControl(new BMap.NavigationControl());   //缩放按钮
	map.addControl(new BMap.MapTypeControl( {mapTypes: [BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]} ));   //添加地图类型控件 离线只支持普通、卫星地图; 三维不支持
	

	var TILE_SIZE = 256;

	//添加地图类型控件
	map.addControl(new BMap.MapTypeControl({
		mapTypes:[
           	BMAP_NORMAL_MAP,
           	BMAP_HYBRID_MAP
       ]}));	  

	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
	map.enableKeyboard();
	map.enableContinuousZoom();    // 开启连续缩放效果
	map.enableInertialDragging();　// 开启惯性拖拽效果
	//map.addEventListener("zoomend", function(){     alert("地图缩放至：" + this.getZoom() + "级");    });
//**********************************************communication witn QT***************************************************//

	var context;

	// 初始化
	function init()
	{
		//alert("接收到Qt发送的消息" );
    		if (typeof qt != 'undefined')
    		{
        		new QWebChannel(qt.webChannelTransport, function(channel)
        		{
        			context = channel.objects.context;
        		}
        		);
    		}
    		else
    		{
        		alert("qt对象获取失败！");
   		 }
	}
	// 向qt发送消息
	function sendMessage(msg1,msg2)
	{
    		if(typeof context == 'undefined')
    		{
        		alert("context对象获取失败！");
    		}
    		else
    		{
        		context.onMsg(msg1,msg2);
    		}
	}
	// 控件控制函数
	function onBtnSendMsg()
	{
    		var cmd = document.getElementById("待发送消息").value;
    		sendMessage(123);   
	}
	// 接收qt发送的消息
	function recvMessage(msg)
	{
    		alert("接收到Qt发送的消息：" + msg);
	}
	init();



	map.addEventListener('click', function(e){
  	var lngLat = e.point;  
	sendMessage(lngLat.lat,lngLat.lng);
	addMarker(lngLat.lat,lngLat.lng);
	});


	//var info = new BMap.InfoWindow('', {width: 260});
  	//var projection = this.getMapType().getProjection();

  	//var lngLatStr = "经纬度：" + lngLat.lng + ", " + lngLat.lat;
  
  	//var worldCoordinate = projection.lngLatToPoint(lngLat);
  	//var worldCoordStr = "<br />平面坐标：" + worldCoordinate.x + ", " + worldCoordinate.y;
  
  	//var pixelCoordinate = new BMap.Pixel(Math.floor(worldCoordinate.x * Math.pow(2, this.getZoom() - 18)), 
                                       Math.floor(worldCoordinate.y * Math.pow(2, this.getZoom() - 18)));
  	//var pixelCoordStr = "<br />像素坐标：" + pixelCoordinate.x + ", " + pixelCoordinate.y;
  
  	//var tileCoordinate = new BMap.Pixel(Math.floor(pixelCoordinate.x / 256),
                                 Math.floor(pixelCoordinate.y / 256));
  	//var tileCoordStr = "<br />图块坐标：" + tileCoordinate.x + ", " + tileCoordinate.y;
  
  	//var viewportCoordinate = map.pointToPixel(lngLat);
  	//var viewportCoordStr = "<br />可视区域坐标：" + viewportCoordinate.x + ", " + viewportCoordinate.y;
  
  	//var overlayCoordinate = map.pointToOverlayPixel(lngLat);
  	//var overlayCoordStr = "<br />覆盖物坐标：" + overlayCoordinate.x + ", " + overlayCoordinate.y;
  
  	//info.setContent(lngLatStr + worldCoordStr + pixelCoordStr + tileCoordStr + 
        //          viewportCoordStr + overlayCoordStr);
  	//map.openInfoWindow(info, lngLat);
	
//**************************************编写自定义函数,创建标注******************************************//
	function addMarker(lat,lng){
		var point = new BMap.Point(lng,lat);
	  	var marker = new BMap.Marker(point);
	  	map.addOverlay(marker);
	}
	

	//监听地图缩放
    map.addEventListener("zoomend", function(){ 
        if( this.getZoom() > 8 ) {
            layer.msg("默认只有8级地图, 超过无法显示"); 
        } 
    });
</script>
</html>
